# DDE File Manager 单元测试框架重建项目计划

## 项目概述

**目标**: 为dde-file-manager项目重建单元测试框架，首先为dfm-framework模块编写单元测试

**技术栈**: GTest + GMock + lcov + Qt6 + DTK6

**策略**: 渐进式开发，保持现有tests目录不变，新建tests2目录作为全新测试工作区

---

## 版本规划

### 1.0 版本 - 最小可行版本 (MVP)
**目标**: 建立基础测试框架，能够独立编译并运行dfm-framework的基础测试

### 2.0 版本 - 功能完善版本
**目标**: 完善测试覆盖率，添加完整的工具链和自动化脚本

### 3.0 版本 - 优化扩展版本
**目标**: 扩展到其他模块，优化开发体验

---

## 任务详细规划

### 1.0 版本任务

#### TASK001 - 基础框架搭建
- **版本**: 1.0
- **状态**: 计划中
- **描述**: 创建tests2目录结构和基础CMake配置

**子任务清单**:
1. 创建tests2目录结构
2. 编写根CMakeLists.txt
3. 创建通用测试工具文件
4. 验证独立编译

**AI编程助手提示词**:
```
你是一个C++/CMake专家，正在为dde-file-manager项目创建全新的单元测试框架。

背景信息：
- 项目使用Qt6 + DTK6 + C++17
- 现有tests目录保持不变，新建tests2作为测试工作区
- 需要支持独立编译和作为子项目编译两种模式
- 使用GTest + GMock + lcov工具链
- 主要测试目标是src/dfm-framework模块

任务要求：
1. 在项目根目录创建tests2目录结构
2. 编写tests2/CMakeLists.txt，支持独立编译和子项目编译
3. 创建tests2/common/目录，包含通用测试工具
4. 确保CMake配置能正确找到Qt6、DTK6、GTest等依赖
5. 添加覆盖率编译选项(-fprofile-arcs -ftest-coverage)

技术要求：
- CMake 3.10+兼容
- 支持Debug和Release构建类型
- 包含必要的编译定义(QT_MESSAGELOGCONTEXT等)
- 正确设置include路径和链接库
- 支持通过环境变量DFM_TEST_MODE控制测试行为

请创建完整的目录结构和CMakeLists.txt文件，确保能够独立编译通过。
```

#### TASK002 - dfm-framework测试模块初始化
- **版本**: 1.0
- **状态**: 计划中
- **描述**: 创建dfm-framework测试模块的基础结构

**子任务清单**:
1. 创建tests2/dfm-framework目录结构
2. 编写dfm-framework测试的CMakeLists.txt
3. 创建基础测试文件模板
4. 验证编译链接

**AI编程助手提示词**:
```
你是一个C++测试专家，正在为dde-file-manager的dfm-framework模块创建单元测试。

背景信息：
- dfm-framework位于src/dfm-framework，包含event、lifecycle、listener、log、backtrace等子模块
- 使用Qt6::Core、Qt6::Concurrent、Dtk6::Core作为依赖
- 构建目标是共享库dfm6-framework，别名DFM6::framework
- 现有tests/dfm-framework有旧的Qt5测试代码可以参考

任务要求：
1. 在tests2/创建dfm-framework测试目录结构
2. 编写tests2/dfm-framework/CMakeLists.txt
3. 创建各子模块的测试目录(event、lifecycle等)
4. 编写一个简单的测试文件验证框架工作
5. 确保能正确链接到dfm6-framework库

技术要求：
- 使用GTest框架，包含gtest/gtest.h
- 支持独立编译和作为父项目子模块编译
- 正确处理Qt6和DTK6依赖
- 包含cpp-stub打桩工具支持
- 设置适当的测试环境变量

请创建完整的测试模块结构，包含一个可以编译运行的示例测试。
```

#### TASK003 - Event模块测试迁移
- **版本**: 1.0
- **状态**: 计划中
- **描述**: 将现有event模块测试从Qt5迁移到Qt6

**子任务清单**:
1. 分析现有event测试代码
2. 迁移ut_eventchannel.cpp到新框架
3. 迁移ut_eventdispatcher.cpp到新框架
4. 迁移ut_eventsequence.cpp到新框架
5. 修复Qt5到Qt6的兼容性问题

**AI编程助手提示词**:
```
你是一个Qt/C++专家，正在将dde-file-manager的event模块测试从Qt5迁移到Qt6。

背景信息：
- 现有测试位于tests/dfm-framework/event/，使用Qt5和旧版DTK
- 源码已升级到Qt6，位于src/dfm-framework/event/
- 需要迁移到新的tests2/dfm-framework/event/目录
- 使用GTest框架，包含EventChannel、EventDispatcher、EventSequence等类的测试

现有测试文件：
- ut_eventchannel.cpp: 测试事件通道的同步/异步发送
- ut_eventdispatcher.cpp: 测试事件分发器
- ut_eventsequence.cpp: 测试事件序列
- testqobject.h/cpp: 测试辅助类

任务要求：
1. 分析现有测试代码的逻辑和测试用例
2. 将Qt5依赖更新为Qt6依赖
3. 将Dtk依赖更新为Dtk6依赖
4. 修复API变化导致的编译错误
5. 确保所有测试用例能正确运行
6. 保持测试逻辑的完整性

技术要求：
- 使用Qt6::Core和Qt6::Concurrent
- 使用Dtk6::Core
- 保持GTest测试结构不变
- 正确包含dfm-framework头文件
- 处理Qt5到Qt6的API变化

请逐个迁移测试文件，确保编译通过且测试逻辑正确。
```

#### TASK004 - 基础测试脚本
- **版本**: 1.0
- **状态**: 计划中
- **描述**: 创建基础的测试运行脚本

**子任务清单**:
1. 创建tests2/scripts目录
2. 编写run-tests.sh脚本
3. 编写简单的覆盖率生成脚本
4. 测试脚本功能

**AI编程助手提示词**:
```
你是一个Linux Shell脚本专家，正在为dde-file-manager的tests2项目创建测试运行脚本。

背景信息：
- tests2项目支持独立编译，使用CMake构建系统
- 需要支持一键运行所有测试并生成覆盖率报告
- 使用lcov工具生成HTML覆盖率报告
- 测试需要设置DFM_TEST_MODE=1环境变量确保安全

任务要求：
1. 创建tests2/scripts/run-tests.sh脚本
2. 脚本应该能够：
   - 自动创建构建目录
   - 配置CMake（Debug模式，启用覆盖率）
   - 编译测试项目
   - 运行所有测试
   - 生成基础覆盖率报告
3. 创建tests2/scripts/generate-coverage.sh脚本用于覆盖率生成
4. 添加适当的错误处理和日志输出

技术要求：
- 使用bash shell
- 支持并行编译（make -j$(nproc)）
- 设置正确的环境变量
- 使用ctest运行测试
- 集成lcov和genhtml工具
- 提供清晰的输出信息

请创建功能完整的测试脚本，确保能够一键运行测试并生成报告。
```

### 2.0 版本任务

#### TASK005 - Lifecycle模块测试开发
- **版本**: 2.0
- **状态**: 计划中
- **描述**: 为lifecycle模块编写完整的单元测试

**子任务清单**:
1. 分析lifecycle模块源码结构
2. 设计测试用例覆盖主要功能
3. 编写插件管理相关测试
4. 编写生命周期管理测试
5. 处理复杂依赖的Mock策略

**AI编程助手提示词**:
```
你是一个C++测试专家，正在为dde-file-manager的dfm-framework/lifecycle模块编写单元测试。

背景信息：
- lifecycle模块包含Plugin、PluginManager、PluginMetaObject等核心类
- 负责插件的生命周期管理、加载、卸载等功能
- 使用Qt6的元对象系统和DTK6框架
- 涉及动态库加载、插件依赖管理等复杂逻辑

源码文件：
- lifecycle.cpp: 生命周期管理核心逻辑
- plugin.cpp: 插件基类
- pluginmanager.cpp: 插件管理器
- pluginmetaobject.cpp: 插件元对象
- pluginquickmetadata.cpp: 插件快速元数据

任务要求：
1. 分析各个类的公共接口和核心功能
2. 设计测试用例覆盖：
   - 插件加载/卸载流程
   - 插件依赖关系处理
   - 生命周期状态转换
   - 错误处理机制
3. 使用Mock技术处理文件系统操作
4. 使用cpp-stub处理动态库加载
5. 确保测试的隔离性和可重复性

技术要求：
- 使用GTest和GMock框架
- 正确处理Qt6的信号槽机制
- Mock文件系统和动态库操作
- 测试异步操作和回调
- 覆盖异常情况和边界条件

请为lifecycle模块创建全面的单元测试，确保高代码覆盖率。
```

#### TASK006 - 完整覆盖率报告系统
- **版本**: 2.0
- **状态**: 计划中
- **描述**: 完善覆盖率报告生成，支持HTML查看和过滤

**子任务清单**:
1. 优化lcov配置，正确过滤第三方代码
2. 生成详细的HTML覆盖率报告
3. 添加覆盖率阈值检查
4. 集成到CI/CD流程准备

**AI编程助手提示词**:
```
你是一个DevOps和测试工具专家，正在为dde-file-manager项目完善覆盖率报告系统。

背景信息：
- 项目使用lcov + genhtml生成覆盖率报告
- 需要过滤第三方代码、测试代码、生成代码等
- 要求生成美观的HTML报告，支持按模块查看
- 需要设置覆盖率阈值，低于阈值时构建失败

任务要求：
1. 优化tests2/scripts/generate-coverage.sh脚本
2. 配置lcov正确的包含/排除规则：
   - 包含：src/dfm-framework/*
   - 排除：tests*、3rdparty/*、build*、*moc_*、*qrc_*等
3. 生成分模块的覆盖率报告
4. 添加覆盖率阈值检查（如：行覆盖率>80%）
5. 优化HTML报告的样式和导航

技术要求：
- 熟练使用lcov和genhtml工具
- 正确配置过滤规则
- 生成结构化的报告目录
- 添加脚本参数支持不同的报告模式
- 集成覆盖率阈值检查逻辑

请创建完整的覆盖率报告系统，确保报告准确、美观、易用。
```

#### TASK007 - 其他模块测试框架
- **版本**: 2.0
- **状态**: 计划中
- **描述**: 为listener、log、backtrace模块创建测试框架

**子任务清单**:
1. 创建listener模块测试结构
2. 创建log模块测试结构
3. 创建backtrace模块测试结构
4. 编写基础测试用例
5. 验证模块间集成测试

**AI编程助手提示词**:
```
你是一个C++测试架构师，正在为dde-file-manager的dfm-framework剩余模块创建测试框架。

背景信息：
- 需要为listener、log、backtrace三个模块创建测试
- listener模块处理事件监听和回调
- log模块处理日志记录和输出
- backtrace模块处理调试信息和堆栈跟踪
- 这些模块相互依赖，需要考虑集成测试

任务要求：
1. 分析各模块的源码结构和依赖关系
2. 为每个模块创建独立的测试目录和CMakeLists.txt
3. 设计测试用例覆盖核心功能：
   - listener: 事件监听、回调机制、生命周期
   - log: 日志级别、输出格式、性能
   - backtrace: 堆栈捕获、符号解析、错误处理
4. 处理模块间的依赖关系
5. 编写集成测试验证模块协作

技术要求：
- 使用GTest框架
- 合理使用Mock和Stub技术
- 处理异步操作和多线程场景
- 测试错误处理和边界条件
- 确保测试的独立性和可重复性

请为这三个模块创建完整的测试框架，包含基础测试用例。
```

### 3.0 版本任务

#### TASK008 - 测试工具优化
- **版本**: 3.0
- **状态**: 计划中
- **描述**: 优化测试工具和开发体验

**子任务清单**:
1. 创建测试代码生成工具
2. 优化Mock和Stub工具
3. 添加性能基准测试支持
4. 创建测试数据管理工具

**AI编程助手提示词**:
```
你是一个测试工具开发专家，正在为dde-file-manager项目优化测试开发体验。

背景信息：
- 项目已有基础的GTest测试框架
- 开发者需要频繁编写新的测试用例
- 需要更好的Mock和Stub工具支持
- 希望添加性能回归测试能力

任务要求：
1. 创建测试代码生成工具：
   - 根据源码自动生成测试模板
   - 支持批量生成测试文件
   - 生成Mock类模板
2. 优化现有的cpp-stub工具集成
3. 集成Google Benchmark进行性能测试
4. 创建测试数据管理工具：
   - 生成测试用的临时文件
   - 管理测试数据库
   - 清理测试环境

技术要求：
- 使用Python或Shell脚本开发工具
- 解析C++源码生成测试模板
- 集成到现有的CMake构建系统
- 提供命令行接口
- 生成符合项目规范的代码

请创建一套完整的测试工具链，提升开发者的测试编写效率。
```

#### TASK009 - 扩展到其他模块
- **版本**: 3.0
- **状态**: 计划中
- **描述**: 将测试框架扩展到dfm-base等其他核心模块

**子任务清单**:
1. 分析dfm-base模块结构
2. 创建dfm-base测试框架
3. 迁移现有dfm-base测试
4. 扩展到其他核心模块

**AI编程助手提示词**:
```
你是一个大型C++项目测试架构师，正在将成熟的测试框架扩展到dde-file-manager的其他核心模块。

背景信息：
- 已经为dfm-framework建立了完善的测试框架
- 需要扩展到dfm-base、dfm-extension等其他核心模块
- dfm-base包含文件操作、UI组件、工具函数等基础功能
- 需要保持测试框架的一致性和可维护性

任务要求：
1. 分析目标模块的结构和依赖关系
2. 设计模块化的测试框架扩展方案
3. 创建通用的测试工具和Mock库
4. 处理模块间的依赖和集成测试
5. 建立测试最佳实践文档

技术要求：
- 保持与现有测试框架的一致性
- 合理设计测试的分层架构
- 处理复杂的UI组件测试
- 支持文件系统操作的安全测试
- 建立可扩展的测试基础设施

请设计一个可扩展的测试框架架构，支持快速扩展到其他模块。
```

#### TASK010 - 文档和最佳实践
- **版本**: 3.0
- **状态**: 计划中
- **描述**: 完善测试文档和开发指南

**子任务清单**:
1. 编写完整的README.md
2. 创建测试开发指南
3. 建立测试最佳实践文档
4. 创建故障排除指南

**AI编程助手提示词**:
```
你是一个技术文档专家，正在为dde-file-manager的tests2项目编写完整的文档体系。

背景信息：
- tests2是一个独立的单元测试项目
- 使用GTest + GMock + lcov技术栈
- 支持独立编译和一键测试
- 面向C++开发者，需要清晰的使用指南

任务要求：
1. 编写tests2/README.md，包含：
   - 项目概述和目标
   - 快速开始指南
   - 构建和运行说明
   - 目录结构说明
   - 常见问题解答
2. 创建开发者指南，包含：
   - 如何编写新的测试用例
   - Mock和Stub的使用方法
   - 测试最佳实践
   - 代码覆盖率要求
3. 创建故障排除文档
4. 建立贡献指南

技术要求：
- 使用Markdown格式
- 包含代码示例和截图
- 结构清晰，易于导航
- 面向不同技能水平的开发者
- 保持文档的时效性

请创建完整的文档体系，帮助开发者快速上手和高效使用测试框架。
```

---

## 实施计划

### 里程碑时间线

- **1.0 版本**: 2周内完成
  - Week 1: TASK001-TASK002 (基础框架)
  - Week 2: TASK003-TASK004 (Event测试和脚本)

- **2.0 版本**: 4周内完成
  - Week 3-4: TASK005-TASK006 (Lifecycle和覆盖率)
  - Week 5-6: TASK007 (其他模块测试)

- **3.0 版本**: 6周内完成
  - Week 7-8: TASK008-TASK009 (工具优化和扩展)
  - Week 9-10: TASK010 (文档完善)

### 质量保证

每个任务完成后必须满足：
1. ✅ 代码能够编译通过
2. ✅ 所有测试用例通过
3. ✅ 覆盖率报告正常生成
4. ✅ 脚本能够正常运行
5. ✅ 文档更新完整

### 风险控制

- **技术风险**: Qt5到Qt6迁移可能遇到API兼容性问题
- **依赖风险**: DTK6和其他系统库的版本兼容性
- **集成风险**: 与现有构建系统的集成复杂度

**缓解措施**: 每个任务都要求能够独立编译，降低集成风险；保持与现有tests目录的隔离，避免影响现有功能。 